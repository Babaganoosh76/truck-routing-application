{% extends "base.html" %}

{% block title %}
<title>Load Details</title>
{% endblock %}

{% block content %}
<section id="load">
	<h1>Load Details</h1>
	<div class="row">
		<div class="column">
			<h6>Driver:</h6>
			<p>{{ driver.name if driver else load.driver }}</p>
			<h6>Vehicle:</h6>
			<p>{{ load.vehicle if load.vehicle else 'Unknown' }}</p>
			<h6>Date:</h6>
			<p>{{ load.date.strftime('%B %-d') }}</p>
			<h6>Hand Tag:</h6>
			<p>{{ load.hand_tag }}</p>
			<h6>P.O. Number:</h6>
			<p>{{ load.po_num }}</p>
		</div>
		<div class="column">
			<h6>Customer:</h6>
			<p>{{ load.customer }}</p>
			<h6>Origin:</h6>
			<p id="origin">{{ load.origin }}</p>
			<h6>Destination:</h6>
			<p id="destination">{{ load.destination }}</p>
			<h6>Pre-Load:</h6>
			<p id="destination">{{ 'Yes' if load.preload else 'No' }}</p>
		</div>
		<div class="column">
			<table class="load-details">
				{% if not load.subhaul %}
				<tr>
					<td>Total Mileage:</td>
					<td id="mileage">Calculating...</td>
				</tr>
				<tr>
					<td>Income/Mile:</td>
					<td id="ipm">Calculating...</td>
				</tr>
				<tr>
					<td>Avg. Cost/Mile:</td>
					<td>- ${{ '%0.2f'%cpm|float }}</td>
				</tr>
			</table>

			<table class="load-details">
				<tr>
					<td>Amount Billed:</td>
					<td>${{ '%0.2f'%load.amount_billed|float }}</td>
				</tr>
				<tr>
					<td>Travel Cost:</td>
					<td id="tc">Calculating...</td>
				</tr>
				<tr>
					<td>Driver's Wage:</td>
					<td id="dw">Calculating...</td>
				</tr>
				<tr class="total">
					<td>Total Profit:</td>
					<td id="tp">Calculating...</td>
				</tr>
				{% else %}
				<tr>
					<td>Amount Billed:</td>
					<td>${{ '%0.2f'%load.amount_billed|float }}</td>
				</tr>
				<tr>
					<td>Amount Paid:</td>
					<td id="dw">${{ '%0.2f'%load.amount_paid|float }}</td>
				</tr>
				<tr class="total">
					<td>Total Profit:</td>
					<td id="tp">${{ '%0.2f'%(load.amount_billed-load.amount_paid)|float }}</td>
				</tr>
				{% endif %}
			</table>
		</div>
	</div>
	<div id="map"></div>
	<a class="button" href="{{url_for('.edit_load_id', lid=load._id)}}">Edit Load</a>
</section>

<script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDe2svPTpoA8wbJkR32E-dZCgH_ZNPvfdg&libraries=places&callback=init" async defer></script>

<script type="text/javascript">
	var directions_service, directions_renderer, places_service, map

	function init() {
		map = new google.maps.Map($('#map')[0], {
			center: {lat: 38.5816, lng: -121.4944},
			disableDoubleClickZoom: true,
			fullscreenControl: false,
			gestureHandling: 'auto',
			keyboardShortcuts: true,
			mapTypeControl: false,
			mapTypeId: 'roadmap',
			scrollwheel: false,
			streetViewControl: false,
			zoom: 7
		})
		directions_service = new google.maps.DirectionsService()
		directions_renderer = new google.maps.DirectionsRenderer()
		places_service = new google.maps.places.PlacesService(map);
		directions_renderer.setMap(map)

		calc_route('{{ load.origin }}','{{ load.destination }}')
	}

	function calc_route(orig, dest) {
		var request = {
			origin: orig.split(', CA')[0] + ', CA',
			destination: dest.split(', CA')[0] + ', CA',
			travelMode: 'DRIVING'
		}
		directions_service.route(request, function(res, status) {
			// console.log(res)
			if (status == 'OK') {
				directions_renderer.setDirections(res)
				{% if not load.subhaul %}
				var mi = res['routes'][0]['legs'][0]['distance']['value']*0.000621371
				var ipm = ({{ load.amount_billed }}/mi)
				var tc = ({{ cpm }}*mi)
				$('#mileage').text(mi.toFixed(1) + ' mi')
				$('#ipm').text('$' + ipm.toFixed(2))
				$('#tc').text('- $' + tc.toFixed(2))

				{% if driver %}
				var dw = ({{ load.amount_billed }}*{{ driver.percentage/100 }})
				$('#dw').text('- $' + dw.toFixed(2))
				$('#tp').text('$' + ({{ load.amount_billed }}-tc-dw).toFixed(2))
				{% else %}
				$('#dw').text('Unknown')
				$('#tp').text('$' + ({{ load.amount_billed }}-tc).toFixed(2))
				{% endif %}

				{% endif %}
			} else {
				$('#mileage').text('Unable to calculate')
				if (res['geocoded_waypoints'][0]['geocoder_status'] != 'OK') {
					console.log('Origin not found')
					$('#origin').append('<p class="not-found"> - NOT FOUND</p>')
				} else {
					plot_marker(res['geocoded_waypoints'][0]['place_id'], 'A')
				}
				if (res['geocoded_waypoints'][1]['geocoder_status'] != 'OK') {
					console.log('Destination not found')
					$('#destination').append('<p class="not-found"> - NOT FOUND</p>')
				} else {
					plot_marker(res['geocoded_waypoints'][1]['place_id'], 'B')
				}
			}
		})
	}

	function plot_marker(pid, label='A') {
		places_service.getDetails({placeId: pid}, function(place, status) {
			var marker = new google.maps.Marker({
				map: map,
				position: place.geometry.location,
				label: label
			})
			map.setCenter(place.geometry.location)
		})
	}

	function round_to(num,dec) {
		return Math.round(num*Math.pow(10,dec))/Math.pow(10,dec)
	}
</script>

{% endblock %}